<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ö–∞—Ä—Ç–æ—Ç–µ–∫–∞ –°–≤–µ—Ç–ª–∞–Ω—ã</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <style>
        :root { 
            --pink: #f2bac9; 
            --dark: var(--tg-theme-text-color, #5b4d42); 
            --bg: #fcf1f1; 
            --mint: #e8f5e9; 
            --lemon: #fff9c4; 
            --red: #ff5252; 
            --tg: #5b4d42; 
            --gold: #ffd700; 
            --done-green: #27ae60; 
            --cancel-red: #eb4d4b;
            --secondary-bg: var(--tg-theme-secondary-bg-color, #ffffff);
            --hint: #a69a9a;
            --border: #f0e2e2;
        }

        /* –£–ª—É—á—à–µ–Ω–Ω–∞—è –¢–ï–ú–ù–ê–Ø –¢–ï–ú–ê */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #121212; 
                --secondary-bg: #1e1e1e; 
                --dark: #e0e0e0; 
                --border: #2c2c2c; 
                --hint: #888888;
                --pink: #ff8fa3; 
            }
            body { background-color: var(--bg); color: var(--dark); }
            .item, .header-card, .v-card, .info-box, .total-card { 
                background: var(--secondary-bg); 
                border-color: var(--border); 
                box-shadow: 0 4px 15px rgba(0,0,0,0.4); 
            }
            .item:hover {
                box-shadow: 0 8px 25px rgba(0,0,0,0.6), 0 4px 12px rgba(242, 186, 201, 0.3);
                border-color: var(--pink);
            }
            .item-number {
                color: var(--dark);
                opacity: 0.4;
            }
            #search, .f-btn, .s-btn, .client-counter, .tag, .inp, .st-btn { 
                background: #252525; 
                border-color: var(--border); 
                color: var(--dark); 
            }
            .back-btn {
                background: #252525;
                border-color: var(--border);
                color: #000000;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            }
            .del-btn {
                background: #252525;
                border-color: var(--pink);
            }
            .search-box { background: var(--bg); }
            .info-box.b-gold { background: #1a1617; border-color: var(--pink); }
            .box-value, .phone-value-big, .client-name { color: #ffffff; }
            .box-label { color: #000000; }
            .child-info { color: #999999; }
            .addr-value { color: #999999; }
            .phone-info { color: #999999; }
            .edit-profile-btn { background: #252525; border-color: var(--border); color: var(--hint); }
            .overlay { background: rgba(0, 0, 0, 0.8); }
            #edit-box, #total-edit-box, #client-edit-box, #pay-box, #plan-box, #address-box, #visit-add-box { 
                background: #1e1e1e; 
                border-top: 1px solid var(--border);
            }
            .money-btn { box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        }
        
        body { 
            font-family: -apple-system, sans-serif; 
            background-color: var(--bg);
            margin: 0; 
            color: var(--dark); 
        }
        
        .search-box { position: sticky; top: 0; background: var(--bg); padding: 15px 15px 5px; z-index: 10; }
        #search { 
            width: 100%; padding: 16px; border: 2px solid var(--border); border-radius: 20px; outline: none; 
            box-sizing: border-box; font-size: 0.95rem; background: var(--secondary-bg); color: var(--dark);
            transition: border-color 0.2s;
        }
        #search:focus { border-color: var(--pink); }
        
        .filter-bar { display: flex; gap: 10px; padding: 10px 15px 5px; }
        .f-btn { 
            flex: 1; padding: 12px; border-radius: 15px; border: 2px solid var(--pink); 
            background: var(--secondary-bg); color: var(--pink); font-weight: bold; cursor: pointer; font-size: 1rem; 
            transition: all 0.2s ease;
        }
        .f-btn.active { background: var(--pink); color: white; box-shadow: 0 4px 10px rgba(242, 186, 201, 0.4); }

        .sort-bar { display: flex; gap: 10px; padding: 5px 15px 15px; align-items: center; }
        .s-btn { 
            padding: 8px 16px; border-radius: 12px; border: 1px solid var(--border); 
            background: var(--secondary-bg); color: var(--hint); font-size: 0.85rem; font-weight: bold; cursor: pointer;
            transition: all 0.2s ease;
        }
        .s-btn.active { border-color: var(--pink); color: var(--pink); background: var(--secondary-bg); }
        .client-counter { 
            padding: 8px 16px; border-radius: 12px; border: 1px solid var(--border); 
            background: var(--secondary-bg); color: var(--hint); font-size: 0.85rem; font-weight: bold; margin-left: auto;
        }
        
        .archive-btn {
            width: 100%; padding: 14px; border-radius: 15px; border: 2px dashed var(--hint);
            background: var(--secondary-bg); color: var(--hint); font-weight: bold; cursor: pointer;
            font-size: 0.95rem; transition: all 0.2s ease;
        }
        .archive-btn:hover {
            border-color: var(--pink); color: var(--pink);
            background: rgba(242, 186, 201, 0.05);
        }
        .archive-btn:active {
            transform: scale(0.98);
        }
        
        .item { 
            background: var(--secondary-bg); padding: 22px 22px 22px 70px; border-radius: 28px; margin: 12px 15px; 
            box-shadow: 0 15px 35px rgba(224, 159, 176, 0.25), 0 5px 15px rgba(0, 0, 0, 0.05); 
            position: relative; border: 2px solid var(--border);
            transition: all 0.3s ease;
        }
        .item:hover {
            box-shadow: 0 20px 45px rgba(224, 159, 176, 0.35), 0 8px 20px rgba(242, 186, 201, 0.2);
            transform: translateY(-3px);
            border-color: var(--pink);
        }
        .item-number {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.4rem;
            font-weight: 900;
            color: var(--dark);
            opacity: 0.4;
            line-height: 1;
        }
        
        .status-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 0.7rem;
            padding: 5px 10px;
            border-radius: 10px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .status-badge.in-progress {
            background: linear-gradient(135deg, #2e7d32 0%, #4caf50 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }
        .status-badge.completed {
            background: linear-gradient(135deg, #757575 0%, #9e9e9e 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(117, 117, 117, 0.3);
        }
        .status-badge.waiting {
            background: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(255, 167, 38, 0.3);
        }
        
        .visit-datetime {
            position: absolute;
            bottom: 50px;
            right: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 8px;
        }
        .visit-datetime.today {
            color: #2e7d32;
            background: rgba(46, 125, 50, 0.1);
        }
        .visit-datetime.waiting {
            color: #fb8c00;
            background: rgba(251, 140, 0, 0.1);
        }
        .visit-datetime.completed {
            color: #757575;
            background: rgba(117, 117, 117, 0.1);
        }
        
        .course-trophy {
            position: absolute;
            bottom: 12px;
            right: 12px;
            font-size: 0.65rem;
            padding: 4px 8px;
            border-radius: 8px;
            font-weight: bold;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #8b6914;
            box-shadow: 0 2px 10px rgba(255, 215, 0, 0.4);
            display: flex;
            align-items: center;
            gap: 3px;
        }
        .client-name { font-size: 1.35rem; font-weight: 800; display: block; margin-bottom: 6px; color: var(--dark); }
        .child-info { font-size: 1.1rem; color: var(--dark); margin-bottom: 5px; opacity: 0.9; }
        .phone-info { font-size: 1.1rem; color: var(--hint); display: block; margin-top: 5px; }

        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); overflow-y: auto; z-index: 20; }
        .m-container { padding: 15px; }
        
        .nav-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; gap: 10px; }
        .back-btn { 
            display: flex; align-items: center; gap: 6px;
            padding: 8px 14px; border-radius: 15px; border: 2px solid var(--pink); 
            background: white; color: var(--dark); font-weight: 700; font-size: 0.85rem;
            box-shadow: 0 4px 12px rgba(242, 186, 201, 0.3); cursor: pointer;
        }
        .del-btn {
            display: flex; align-items: center; justify-content: center;
            width: 36px; height: 36px; border-radius: 12px; border: 2px solid var(--border);
            background: white; color: var(--red); font-size: 1rem; cursor: pointer;
        }

        .header-card { background: var(--secondary-bg); padding: 20px; border-radius: 35px; box-shadow: 0 10px 30px rgba(224, 159, 176, 0.2); margin-bottom: 20px; border: 1px solid var(--border); }
        .header-card h2 { margin: 0 0 12px 0; font-size: 1.45rem; text-align: center; color: var(--dark); }
        .edit-profile-btn { 
            width: 100%; padding: 10px; margin-bottom: 15px; border-radius: 15px; border: 1px solid var(--border); 
            background: #fdf8f9; color: var(--hint); font-size: 0.85rem; font-weight: bold; cursor: pointer; 
        }

        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .info-box { padding: 12px; border-radius: 18px; display: flex; flex-direction: column; gap: 3px; background: white; border: 2px solid var(--border); }
        
        .b-gold { border: 2px solid var(--pink); background: rgba(242, 186, 201, 0.05); grid-column: span 2; box-shadow: none; }
        
        .box-label { font-size: 0.75rem; font-weight: bold; text-transform: uppercase; color: var(--hint); }
        .box-value { font-size: 1.1rem; font-weight: 800; color: var(--dark); }
        
        .addr-box { grid-column: span 2; padding: 10px 15px; }
        .addr-value { font-size: 0.95rem; font-weight: 600; color: var(--dark); }
        .phone-value-big { 
            font-size: 1.3rem; 
            font-weight: 800; 
            color: var(--dark); 
            text-align: center; 
            width: 100%; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: 8px; 
        }

        .add-visit-btn { 
            grid-column: span 2; background: var(--pink); color: white; border: none; padding: 16px; 
            border-radius: 20px; font-weight: 900; font-size: 1rem; margin-top: 5px; margin-bottom: 5px; 
            box-shadow: 0 6px 15px rgba(242, 186, 201, 0.4); text-transform: uppercase; cursor: pointer;
        }

        .actions-grid { 
            grid-column: span 2; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 10px 5px; 
            margin-top: 5px;
        }
        .action-icon {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.15));
            transition: transform 0.1s ease;
            cursor: pointer;
            text-decoration: none;
        }
        .action-icon:active { transform: scale(0.9); }

        .total-card { background: var(--secondary-bg); padding: 20px; border-radius: 25px; border: 2px dashed var(--pink); margin-bottom: 20px; cursor: pointer; }
        
        .v-card { background: var(--secondary-bg); margin-bottom: 12px; padding: 20px; border-radius: 25px; box-shadow: 0 6px 15px rgba(0,0,0,0.03); border-left: 6px solid var(--pink); position: relative; transition: opacity 0.3s; border-top: 1px solid var(--border); border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); }
        .v-card.done { border-left-color: var(--done-green); }
        .v-card.cancelled { border-left-color: var(--cancel-red); }
        
        .status-btn-group { display: flex; gap: 8px; margin-top: 15px; }
        .st-btn { 
            flex: 1; padding: 12px 8px; border-radius: 14px; border: 1px solid var(--border); 
            background: var(--secondary-bg); font-size: 0.8rem; font-weight: 800; cursor: pointer; color: var(--dark); transition: all 0.2s; 
        }
        .st-btn.active-done { background: var(--done-green); color: white; border-color: var(--done-green); box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3); }
        .st-btn.active-cancel { background: var(--cancel-red); color: white; border-color: var(--cancel-red); box-shadow: 0 4px 12px rgba(235, 77, 75, 0.3); }
        .st-btn.inactive { background: var(--secondary-bg); color: var(--hint); border-color: var(--border); box-shadow: none; opacity: 0.5; }

        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(91, 77, 66, 0.5); z-index: 25; backdrop-filter: blur(4px); }
        #edit-box, #total-edit-box, #client-edit-box, #pay-box, #plan-box, #address-box, #visit-add-box, #datetime-edit-box, #price-edit-box { 
            display: none; position: fixed; bottom: 0; left: 0; width: 100%; background: var(--bg); 
            padding: 25px; border-radius: 35px 35px 0 0; box-shadow: 0 -10px 40px rgba(0,0,0,0.2); 
            z-index: 30; box-sizing: border-box; 
        }

        .tag { display: inline-block; background: var(--secondary-bg); padding: 8px 12px; border-radius: 12px; font-size: 0.85rem; margin: 0 5px 10px 0; cursor: pointer; border: 1px solid var(--border); color: var(--dark); font-weight: 600; }
        .tag.selected { background: var(--pink); color: white; border-color: var(--pink); }
        .save-btn { background: #5b4d42; color: white; border: none; padding: 20px; border-radius: 20px; width: 100%; font-weight: 900; font-size: 1.1rem; margin-top: 10px; text-transform: uppercase; box-shadow: 0 5px 15px rgba(91, 77, 66, 0.2); }
        .inp { 
            width: 100%; padding: 15px; border: 2px solid var(--border); border-radius: 15px; 
            margin-bottom: 10px; font-size: 1rem; box-sizing: border-box; outline: none; background: var(--secondary-bg); color: var(--dark); 
        }
        .inp:focus { border-color: var(--pink); }

        .money-btn { background: #27ae60; border: none; color: white; padding: 14px; border-radius: 15px; font-weight: 900; width: 100%; margin-top: 10px; cursor: pointer; font-size: 1rem; box-shadow: 0 4px 10px rgba(39, 174, 96, 0.2); }
        .delete-btn { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 1.2rem; cursor: pointer; z-index: 5; }
    </style>
</head>
<body>
    <div class="search-box">
        <input type="text" id="search" placeholder="üîé –ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞: –º–∞–º–∞, —Ä–µ–±—ë–Ω–æ–∫ –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω" oninput="render()">
    </div>
    
    <div class="filter-bar">
        <button class="f-btn active" id="f-all" onclick="setF('all')">–í—Å–µ</button>
        <button class="f-btn" id="f-today" onclick="setF('today')">–°–µ–≥–æ–¥–Ω—è</button>
        <button class="f-btn" id="f-tomorrow" onclick="setF('tomorrow')">–ó–∞–≤—Ç—Ä–∞</button>
    </div>

    <div class="sort-bar">
        <button class="s-btn" id="s-alpha" onclick="setSort('alpha')">–ê-–Ø</button>
        <button class="s-btn" id="s-date" onclick="setSort('date')">–ü–æ –¥–∞—Ç–µ</button>
        <div class="client-counter" id="counter">–ö–ª–∏–µ–Ω—Ç–æ–≤: 0</div>
    </div>
    
    <div id="archive-bar" style="display: none; padding: 10px 15px;">
        <button class="archive-btn" id="archive-btn" onclick="loadArchive()">
            üì¶ –ü–æ–∫–∞–∑–∞—Ç—å –∞—Ä—Ö–∏–≤ (<span id="archive-count">0</span>)
        </button>
    </div>

    <div id="list"></div>

    <div id="modal">
        <div class="m-container">
            <div class="nav-row">
                <button class="back-btn" onclick="closeM()">
                    <span style="font-size: 1.1rem;">‚Äπ</span> –ù–ê–ó–ê–î
                </button>
                <div id="trophy-badge" style="display: none; padding: 6px 12px; border-radius: 12px; background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); color: #8b6914; font-weight: bold; font-size: 0.75rem; box-shadow: 0 2px 10px rgba(255, 215, 0, 0.4);"></div>
                <button class="del-btn" onclick="askDelete()">üóë</button>
            </div>
            <div id="m-content"></div>
        </div>
    </div>

    <div id="overlay" class="overlay" onclick="closeOverlay()"></div>

    <div id="visit-add-box">
        <h4 style="margin-top:0; text-align:center; color: var(--dark);">üóì –ó–∞–ø–∏—Å–∞—Ç—å –Ω–∞ —Å–µ–∞–Ω—Å</h4>
        <div id="service-tags" style="margin-bottom:15px; text-align:center; display: flex; flex-wrap: wrap; justify-content: center; gap: 5px;">
            <span class="tag" onclick="selectService('–ö–£–†–° (10 —Å–µ–∞–Ω—Å–æ–≤)', this)">–ö–£–†–° (10 —Å–µ–∞–Ω—Å–æ–≤)</span>
            <span class="tag" onclick="selectService('–î–µ—Ç—Å–∫–∏–π –º–∞—Å—Å–∞–∂', this)">–î–µ—Ç—Å–∫–∏–π –º–∞—Å—Å–∞–∂</span>
            <span class="tag" onclick="selectService('–í–∑—Ä–æ—Å–ª—ã–π –º–∞—Å—Å–∞–∂', this)">–í–∑—Ä–æ—Å–ª—ã–π –º–∞—Å—Å–∞–∂</span>
            <span class="tag" onclick="selectService('–ö–û–ù–°–£–õ–¨–¢–ê–¶–ò–Ø', this)">–ö–û–ù–°–£–õ–¨–¢–ê–¶–ò–Ø</span>
        </div>
        <div class="box-label" style="margin-bottom:5px;">–î–∞—Ç–∞ –≤–∏–∑–∏—Ç–∞</div>
        <input type="date" id="av-date" class="inp">
        <div class="box-label" style="margin-bottom:5px;">–í—Ä–µ–º—è</div>
        <input type="time" id="av-time" class="inp">
        <div class="box-label" style="margin-bottom:5px;">–¶–µ–Ω–∞ –∑–∞ 1 —Å–µ–∞–Ω—Å (‚ÇΩ) <span style="color: red;">*</span></div>
        <input type="number" id="va-price" class="inp" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 2000" inputmode="numeric" required min="1">
        <button class="save-btn" style="background:var(--pink);" onclick="saveNewVisit()">–ó–ê–ü–ò–°–ê–¢–¨</button>
    </div>

    <div id="address-box">
        <h4 style="margin-top:0; color: var(--dark); text-align: center;">üìç –î–µ—Ç–∞–ª–∏ –¥–æ—Å—Ç—É–ø–∞</h4>
        <div id="address-details-content"></div>
        <button class="save-btn" style="background: var(--pink);" onclick="closeAllEditBoxes()">–ü–û–ù–Ø–¢–ù–û</button>
    </div>

    <div id="edit-box">
        <h4 id="e-title" style="margin-top:0; margin-bottom:10px; color: var(--dark);">üß∏ –í–∏–∑–∏—Ç</h4>
        <div id="tags-container" style="margin-bottom:10px;"></div>
        <textarea id="e-comm" class="inp" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" rows="2"></textarea>
        <input type="text" id="e-res" class="inp" placeholder="–†–µ–∑—É–ª—å—Ç–∞—Ç (—Ç–µ–≥–∏)">
        <div class="status-btn-group" style="margin-bottom:15px;">
            <button id="eb-done" class="st-btn" onclick="toggleEditStatus('–í–´–ü–û–õ–ù–ï–ù–û')">‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ</button>
            <button id="eb-cancel" class="st-btn" onclick="toggleEditStatus('–û–¢–ú–ï–ù–ï–ù–û')">‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ</button>
        </div>
        <button class="save-btn" onclick="saveE()">–°–û–•–†–ê–ù–ò–¢–¨</button>
    </div>

    <div id="total-edit-box">
        <h4 style="margin-top:0; color: var(--dark);">üèÅ –ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</h4>
        <textarea id="e-total" class="inp" rows="5" placeholder="–ö–∞–∫ –≤—Å—ë –ø—Ä–æ—à–ª–æ –≤ —Ü–µ–ª–æ–º?"></textarea>
        <button class="save-btn" onclick="saveT()">–°–û–•–†–ê–ù–ò–¢–¨ –ò–¢–û–ì</button>
    </div>

    <div id="client-edit-box">
        <h4 style="margin-top:0; color: var(--dark);">‚úèÔ∏è –ü—Ä–æ—Ñ–∏–ª—å –∫–ª–∏–µ–Ω—Ç–∞</h4>
        <div class="box-label" style="margin-bottom:5px;">–§–ò–û –ú–∞–º—ã</div>
        <input type="text" id="ec-name" class="inp">
        <div class="box-label" style="margin-bottom:5px;">–¢–µ–ª–µ—Ñ–æ–Ω</div>
        <input type="text" id="ec-phone" class="inp">
        <div style="display: flex; gap:10px;">
            <div style="flex:2;">
                <div class="box-label" style="margin-bottom:5px;">–ò–º—è —Ä–µ–±–µ–Ω–∫–∞</div>
                <input type="text" id="ec-child" class="inp">
            </div>
            <div style="flex:1;">
                <div class="box-label" style="margin-bottom:5px;">–í–æ–∑—Ä–∞—Å—Ç</div>
                <input type="text" id="ec-age" class="inp">
            </div>
        </div>
        <div class="box-label" style="margin-bottom:5px;">–ê–¥—Ä–µ—Å (–£–ª–∏—Ü–∞, –¥–æ–º, –∫–≤)</div>
        <input type="text" id="ec-addr" class="inp">
        <div style="display: flex; gap:10px;">
            <div style="flex:1;"><div class="box-label" style="margin-bottom:5px;">–ü–æ–¥—ä–µ–∑–¥</div><input type="text" id="ec-entrance" class="inp"></div>
            <div style="flex:1;"><div class="box-label" style="margin-bottom:5px;">–≠—Ç–∞–∂</div><input type="text" id="ec-floor" class="inp"></div>
            <div style="flex:1;"><div class="box-label" style="margin-bottom:5px;">–î–æ–º–æ—Ñ–æ–Ω</div><input type="text" id="ec-intercom" class="inp"></div>
        </div>
        <div class="box-label" style="margin-bottom:5px;">–ó–∞–º–µ—Ç–∫–∞ –∫ –∞–¥—Ä–µ—Å—É</div>
        <input type="text" id="ec-addr-comm" class="inp">
        <button class="save-btn" onclick="saveClient()">–û–ë–ù–û–í–ò–¢–¨ –î–ê–ù–ù–´–ï</button>
    </div>

    <div id="pay-box">
        <h4 style="margin-top:0; color: var(--dark); text-align: center;">üíµ –ó–∞—á–∏—Å–ª–∏—Ç—å –æ–ø–ª–∞—Ç—É</h4>
        <div class="box-label" style="margin-bottom:5px;">–°—É–º–º–∞ –æ–ø–ª–∞—Ç—ã (‚ÇΩ)</div>
        <input type="number" id="pay-amount" class="inp" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 5000" inputmode="numeric">
        <button class="save-btn" onclick="savePay()">–ó–ê–ß–ò–°–õ–ò–¢–¨</button>
    </div>

    <div id="plan-box">
        <h4 style="margin-top:0; color: var(--dark); text-align: center;">üìà –ò–∑–º–µ–Ω–∏—Ç—å –ø–ª–∞–Ω</h4>
        <div class="box-label" style="margin-bottom:5px;">–°—É–º–º–∞ –¥–æ–≥–æ–≤–æ—Ä–∞ (‚ÇΩ)</div>
        <input type="number" id="plan-amount" class="inp" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 15000" inputmode="numeric">
        <button class="save-btn" onclick="savePlan()">–û–ë–ù–û–í–ò–¢–¨ –ü–õ–ê–ù</button>
    </div>

    <div id="datetime-edit-box">
        <h4 style="margin-top:0; color: var(--dark); text-align: center;">üìÖ –ò–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è</h4>
        <div class="box-label" style="margin-bottom:5px;">–î–∞—Ç–∞ –≤–∏–∑–∏—Ç–∞</div>
        <input type="date" id="edit-visit-date" class="inp">
        <div class="box-label" style="margin-bottom:5px;">–í—Ä–µ–º—è</div>
        <input type="time" id="edit-visit-time" class="inp">
        <button class="save-btn" onclick="saveVisitDateTime()">–°–û–•–†–ê–ù–ò–¢–¨ –ò–ó–ú–ï–ù–ï–ù–ò–Ø</button>
    </div>

    <div id="price-edit-box">
        <h4 style="margin-top:0; color: var(--dark); text-align: center;">üí∞ –ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å —Å–µ–∞–Ω—Å–∞</h4>
        <div class="box-label" style="margin-bottom:5px;">–°—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)</div>
        <input type="number" id="edit-visit-price" class="inp" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 2000" inputmode="numeric" required min="1">
        <button class="save-btn" onclick="saveVisitPrice()">–°–û–•–†–ê–ù–ò–¢–¨ –ò–ó–ú–ï–ù–ï–ù–ò–Ø</button>
    </div>

    <script>
        var tg = window.Telegram.WebApp; 
        tg.expand();
        
        var allClients = []; 
        var currentMode = 'all';
        var currentSort = 'added';
        var curV, curC;
        var curEditStatus = "";
        var curVisitStatus = ""; // –î–û–ë–ê–í–ò–õ–ò: —Ö—Ä–∞–Ω–∏—Ç –∏—Å—Ö–æ–¥–Ω—ã–π —Å—Ç–∞—Ç—É—Å –≤–∏–∑–∏—Ç–∞
        let curService = "";
        let selectedService = "";
        let editingVisitId = null; // –î–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã/–≤—Ä–µ–º–µ–Ω–∏
        let editingVisitService = ""; // –î–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫—É—Ä—Å–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
        let archiveLoaded = false; // –§–ª–∞–≥ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—Ä—Ö–∏–≤–∞
        let hasArchive = false; // –ï—Å—Ç—å –ª–∏ –∞—Ä—Ö–∏–≤–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã

        function loadData() {
            const params = new URLSearchParams(window.location.search);
            const rawCompressed = params.get('c_data'); 
            const rawFull = params.get('all_data');
            const archiveCount = params.get('archive_count') || 0;
            hasArchive = params.get('has_archive') === 'true';
            
            if (rawCompressed) {
                try {
                    const binary = atob(rawCompressed.replace(/-/g, '+').replace(/_/g, '/'));
                    const charData = binary.split('').map(x => x.charCodeAt(0));
                    const binData = new Uint8Array(charData);
                    const restored = pako.inflate(binData, { to: 'string' });
                    allClients = JSON.parse(restored);
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∞—Ä—Ö–∏–≤–∞ –µ—Å–ª–∏ –µ—Å—Ç—å –∞—Ä—Ö–∏–≤–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã
                    if (hasArchive && archiveCount > 0) {
                        document.getElementById('archive-count').innerText = archiveCount;
                        document.getElementById('archive-bar').style.display = 'block';
                    }
                    
                    render();
                    checkDirectAccess();
                } catch (e) { 
                    console.error("–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∏:", e);
                    requestDataFromBot();
                }
            } else if (rawFull) {
                allClients = JSON.parse(decodeURIComponent(rawFull));
                render();
                checkDirectAccess();
            } else {
                requestDataFromBot();
            }
        }
        
        function loadArchive() {
            if (archiveLoaded) return;
            
            const btn = document.getElementById('archive-btn');
            btn.innerText = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ö–∏–≤–∞...';
            btn.disabled = true;
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –±–æ—Ç—É –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É –∞—Ä—Ö–∏–≤–∞
            try {
                tg.sendData(JSON.stringify({action: 'get_archive'}));
            } catch(e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∞—Ä—Ö–∏–≤–∞:', e);
                btn.innerText = '‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
                setTimeout(() => {
                    btn.innerText = 'üì¶ –ü–æ–∫–∞–∑–∞—Ç—å –∞—Ä—Ö–∏–≤';
                    btn.disabled = false;
                }, 2000);
            }
        }

        function checkDirectAccess() {
            const params = new URLSearchParams(window.location.search);
            const openId = params.get('open_id') || window.location.hash.replace('#client_', '');
            if (openId && allClients.length > 0) {
                const found = allClients.find(x => x.id == openId);
                if (found) {
                    setTimeout(() => {
                        show(found);
                        const items = document.querySelectorAll('.item');
                        items.forEach(el => {
                            if (el.innerText.includes(found.name)) {
                                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }
                        });
                    }, 300);
                }
            }
        }

        function requestDataFromBot() {
            try { tg.sendData(JSON.stringify({action: 'get_history'})); } catch(e) {}
        }

        window.addEventListener('load', loadData);

        function getClientStatus(client) {
            const now = new Date();
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const todayEnd = new Date(todayStart.getTime() + 24 * 60 * 60 * 1000);
            
            let hasToday = false;
            let hasFuture = false;
            let hasActive = false;
            
            client.visits.forEach(v => {
                if (v.status === '–û—Ç–º–µ–Ω–µ–Ω') return;
                try {
                    const visitDate = new Date(v.date);
                    if (visitDate >= todayStart && visitDate < todayEnd) {
                        hasToday = true;
                    } else if (visitDate >= now) {
                        hasFuture = true;
                    }
                    if (v.status === 'planned' || v.status === '–í—ã–ø–æ–ª–Ω–µ–Ω') {
                        hasActive = true;
                    }
                } catch {}
            });
            
            if (hasToday) return { status: 'in-progress', text: '–°–µ–≥–æ–¥–Ω—è', badge: 'in-progress' };
            if (hasFuture) return { status: 'waiting', text: '–û–∂–∏–¥–∞–µ—Ç', badge: 'waiting' };
            if (hasActive) return { status: 'completed', text: '–ó–∞–≤–µ—Ä—à—ë–Ω', badge: 'completed' };
            return { status: 'completed', text: '–ó–∞–≤–µ—Ä—à—ë–Ω', badge: 'completed' };
        }
        
        function getNextVisitDate(client) {
            const now = new Date();
            let nextVisit = null;
            let lastVisit = null;
            
            client.visits.forEach(v => {
                if (v.status === '–û—Ç–º–µ–Ω–µ–Ω') return;
                try {
                    const visitDate = new Date(v.date);
                    
                    // –ò—â–µ–º –±–ª–∏–∂–∞–π—à–∏–π –±—É–¥—É—â–∏–π –≤–∏–∑–∏—Ç
                    if (visitDate >= now) {
                        if (!nextVisit || visitDate < nextVisit) {
                            nextVisit = visitDate;
                        }
                    }
                    
                    // –ò—â–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π –≤–∏–∑–∏—Ç
                    if (v.status === '–í—ã–ø–æ–ª–Ω–µ–Ω') {
                        if (!lastVisit || visitDate > lastVisit) {
                            lastVisit = visitDate;
                        }
                    }
                } catch {}
            });
            
            return nextVisit || lastVisit;
        }
        
        function formatVisitDateTime(date) {
            if (!date) return '';
            const d = new Date(date);
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            const hours = String(d.getHours()).padStart(2, '0');
            const mins = String(d.getMinutes()).padStart(2, '0');
            return `${day}.${month}.${year} –≤ ${hours}:${mins}`;
        }
        
        function getCompletedCourses(client) {
            // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∫—É—Ä—Å—ã
            // –ö—É—Ä—Å = 10 –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Å–µ–∞–Ω—Å–æ–≤ –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –¥–Ω–µ–π (–∫—Ä–æ–º–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π)
            let allVisits = client.visits.filter(v => 
                v.service && !v.service.includes('–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è') && v.status === '–í—ã–ø–æ–ª–Ω–µ–Ω'
            );
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ
            allVisits.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            let completedCourses = [];
            let courseNumber = 1;
            let usedVisitIds = new Set();
            
            // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –≤–∏–∑–∏—Ç–∞–º –∏ –∏—â–µ–º –≥—Ä—É–ø–ø—ã –∏–∑ 10 —Å–µ–∞–Ω—Å–æ–≤ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 30 –¥–Ω–µ–π
            for (let i = 0; i < allVisits.length; i++) {
                if (usedVisitIds.has(i)) continue;
                
                let courseGroup = [i];
                let startDate = new Date(allVisits[i].date);
                
                // –ò—â–µ–º —Å–ª–µ–¥—É—é—â–∏–µ 9 —Å–µ–∞–Ω—Å–æ–≤ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 30 –¥–Ω–µ–π –æ—Ç –ø–µ—Ä–≤–æ–≥–æ
                for (let j = i + 1; j < allVisits.length && courseGroup.length < 10; j++) {
                    if (usedVisitIds.has(j)) continue;
                    
                    let currentDate = new Date(allVisits[j].date);
                    let daysDiff = (currentDate - startDate) / (1000 * 60 * 60 * 24);
                    
                    if (daysDiff <= 30) {
                        courseGroup.push(j);
                    }
                }
                
                // –ï—Å–ª–∏ –Ω–∞—à–ª–∏ 10 —Å–µ–∞–Ω—Å–æ–≤ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 30 –¥–Ω–µ–π - —ç—Ç–æ –∫—É—Ä—Å
                if (courseGroup.length === 10) {
                    completedCourses.push(courseNumber);
                    courseNumber++;
                    // –ü–æ–º–µ—á–∞–µ–º —ç—Ç–∏ –≤–∏–∑–∏—Ç—ã –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ
                    courseGroup.forEach(idx => usedVisitIds.add(idx));
                }
            }
            
            return completedCourses;
        }
        
        function render() {
            var l = document.getElementById('list'); 
            l.innerHTML = '';
            var q = document.getElementById('search').value.toLowerCase();
            let displayList = [...allClients];
            
            // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ä–µ–∂–∏–º—É
            const now = new Date();
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const todayEnd = new Date(todayStart.getTime() + 24 * 60 * 60 * 1000);
            const tomorrowStart = todayEnd;
            const tomorrowEnd = new Date(tomorrowStart.getTime() + 24 * 60 * 60 * 1000);
            
            if (currentMode === 'today') {
                displayList = displayList.filter(c => {
                    return c.visits.some(v => {
                        if (v.status === '–û—Ç–º–µ–Ω–µ–Ω') return false;
                        try {
                            const visitDate = new Date(v.date);
                            return visitDate >= todayStart && visitDate < todayEnd;
                        } catch { return false; }
                    });
                });
            } else if (currentMode === 'tomorrow') {
                displayList = displayList.filter(c => {
                    return c.visits.some(v => {
                        if (v.status === '–û—Ç–º–µ–Ω–µ–Ω') return false;
                        try {
                            const visitDate = new Date(v.date);
                            return visitDate >= tomorrowStart && visitDate < tomorrowEnd;
                        } catch { return false; }
                    });
                });
            }
            
            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
            if (currentSort === 'alpha') {
                displayList.sort((a, b) => (a.name || "").localeCompare(b.name || ""));
            } else if (currentSort === 'date') {
                // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ –±–ª–∏–∂–∞–π—à–µ–≥–æ —Å–µ–∞–Ω—Å–∞ (—Å–∞–º–∞—è –±–ª–∏–∑–∫–∞—è –∫ –Ω–∞—Å—Ç–æ—è—â–µ–º—É –≤—Ä–µ–º–µ–Ω–∏ - –ø–µ—Ä–≤–∞—è)
                displayList.sort((a, b) => {
                    const dateA = getNextVisitDate(a);
                    const dateB = getNextVisitDate(b);
                    if (!dateA && !dateB) return 0;
                    if (!dateA) return 1;
                    if (!dateB) return -1;
                    return dateA - dateB;
                });
            } else {
                // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ ID –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ (–ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π - –ø–µ—Ä–≤—ã–π)
                displayList.sort((a, b) => b.id - a.id);
            }
            
            let count = 0;
            displayList.forEach((c, index) => {
                var matchS = (c.name + (c.child_name||'') + (c.phone||'')).toLowerCase().includes(q);
                if (matchS) {
                    count++;
                    var d = document.createElement('div'); 
                    d.className = 'item';
                    d.onclick = () => show(c);
                    
                    // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –Ω—É–º–µ—Ä–∞—Ü–∏—è
                    var itemNumber = count;
                    
                    // –°—Ç–∞—Ç—É—Å –∫–ª–∏–µ–Ω—Ç–∞
                    const clientStatus = getClientStatus(c);
                    let statusText = clientStatus.text;
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∞—Ç—É/–≤—Ä–µ–º—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –ø—Ä–∞–≤–æ–º –Ω–∏–∂–Ω–µ–º —É–≥–ª—É
                    let dateTimeDisplay = '';
                    let dateTimeClass = clientStatus.badge;
                    
                    if (currentMode === 'today' || currentMode === 'tomorrow') {
                        // –î–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ "–°–µ–≥–æ–¥–Ω—è" –∏ "–ó–∞–≤—Ç—Ä–∞" - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –≤–∏–∑–∏—Ç–∞
                        const targetStart = currentMode === 'today' ? todayStart : tomorrowStart;
                        const targetEnd = currentMode === 'today' ? todayEnd : tomorrowEnd;
                        
                        const targetVisit = c.visits.find(v => {
                            if (v.status === '–û—Ç–º–µ–Ω–µ–Ω') return false;
                            try {
                                const visitDate = new Date(v.date);
                                return visitDate >= targetStart && visitDate < targetEnd;
                            } catch { return false; }
                        });
                        
                        if (targetVisit) {
                            dateTimeDisplay = formatVisitDateTime(targetVisit.date);
                        }
                    } else {
                        // –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞—Ç—É –±–ª–∏–∂–∞–π—à–µ–≥–æ –∏–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤–∏–∑–∏—Ç–∞
                        const nextDate = getNextVisitDate(c);
                        if (nextDate) {
                            dateTimeDisplay = formatVisitDateTime(nextDate);
                        }
                    }
                    
                    const statusBadge = `<div class="status-badge ${clientStatus.badge}">${statusText}</div>`;
                    const dateTimeBadge = dateTimeDisplay ? `<div class="visit-datetime ${dateTimeClass}">${dateTimeDisplay}</div>` : '';
                    
                    // –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∫—É—Ä—Å—ã
                    const completedCourses = getCompletedCourses(c);
                    const trophyBadge = completedCourses.length > 0 
                        ? `<div class="course-trophy">üèÜ –ü—Ä–æ—à—ë–ª –∫—É—Ä—Å ${completedCourses.join(', ')}</div>` 
                        : '';
                    
                    d.innerHTML = `<div class="item-number">${itemNumber}</div>${statusBadge}${dateTimeBadge}${trophyBadge}<span class="client-name">${c.name}</span>
                        <div class="child-info">üë∂ ${c.child_name || '‚Äî'} ¬∑ ${c.child_age || '?'}</div>
                        <span class="phone-info">üìû ${c.phone || '‚Äî'}</span>`;
                    l.appendChild(d);
                }
            });
            document.getElementById('counter').innerText = `–ö–ª–∏–µ–Ω—Ç–æ–≤: ${count}`;
        }

        function setF(m) {
            currentMode = m;
            currentSort = 'added'; // –ü—Ä–∏ —Å–º–µ–Ω–µ —Ñ–∏–ª—å—Ç—Ä–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –Ω–∞ "–ø–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—é"
            document.getElementById('f-all').className = m === 'all' ? 'f-btn active' : 'f-btn';
            document.getElementById('f-today').className = m === 'today' ? 'f-btn active' : 'f-btn';
            document.getElementById('f-tomorrow').className = m === 'tomorrow' ? 'f-btn active' : 'f-btn';
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫–Ω–æ–ø–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
            document.getElementById('s-alpha').className = 's-btn';
            document.getElementById('s-date').className = 's-btn';
            render();
        }
        
        function setSort(s) {
            currentSort = s;
            document.getElementById('s-alpha').className = s === 'alpha' ? 's-btn active' : 's-btn';
            document.getElementById('s-date').className = s === 'date' ? 's-btn active' : 's-btn';
            render();
        }

        function copyPhone(num, elId) {
            navigator.clipboard.writeText(num).then(() => {
                const el = document.getElementById(elId);
                const oldVal = el.innerText;
                el.innerText = "‚úÖ –°–ö–û–ü–ò–†–û–í–ê–ù–û!";
                el.style.color = "var(--done-green)";
                setTimeout(() => {
                    el.innerText = oldVal;
                    el.style.color = "var(--dark)";
                }, 1200);
            });
        }

        function openAddrDetails(c) {
            const cont = document.getElementById('address-details-content');
            cont.innerHTML = `
                <div style="margin-bottom:20px; text-align:center;">
                    <div style="font-size:1.1rem; font-weight:800; color:var(--dark);">${c.address || '‚Äî'}</div>
                </div>
                <div class="info-grid">
                    <div class="info-box"><span class="box-label">–ü–æ–¥—ä–µ–∑–¥</span><span class="box-value">${c.entrance || '‚Äî'}</span></div>
                    <div class="info-box"><span class="box-label">–≠—Ç–∞–∂</span><span class="box-value">${c.floor || '‚Äî'}</span></div>
                    <div class="info-box addr-box" onclick="copyPhone('${c.intercom}', 'val-ic')">
                        <span class="box-label">üîë –î–æ–º–æ—Ñ–æ–Ω (–Ω–∞–∂–º–∏)</span>
                        <span class="phone-value-big" id="val-ic" style="text-align:center;">${c.intercom || '‚Äî'}</span>
                    </div>
                    <div class="info-box addr-box">
                        <span class="box-label">üìù –ó–∞–º–µ—Ç–∫–∞</span>
                        <div style="font-size:1rem; font-weight:600;">${c.address_comment || '–ù–µ—Ç –∑–∞–º–µ—Ç–æ–∫'}</div>
                    </div>
                </div>`;
            openEditBox('address-box');
        }

        function show(c) {
            curC = c.id; 
            var cont = document.getElementById('m-content');
            var rawPhone = c.phone || "";
            var cleanPhone = rawPhone.replace(/\D/g, '');
            if (cleanPhone.length === 11 && cleanPhone.startsWith('8')) {
                cleanPhone = '7' + cleanPhone.slice(1);
            } else if (cleanPhone.length === 10) {
                cleanPhone = '7' + cleanPhone;
            }
            var formattedPhone = cleanPhone ? '+' + cleanPhone : '‚Äî';
            
            var plan = c.contract_sum || 0;
            var sortedAll = [...c.visits].sort((a,b) => new Date(a.date) - new Date(b.date));
            var groups = [];
            for (let i = 0; i < sortedAll.length; i += 10) {
                groups.push(sortedAll.slice(i, i + 10));
            }
            var finalVisits = [];
            for (let i = groups.length - 1; i >= 0; i--) {
                finalVisits = finalVisits.concat(groups[i]);
            }
            var vHtml = finalVisits.map((v) => {
                // –¶–ï–ù–ê –ë–ï–†–ï–¢–°–Ø –¢–û–õ–¨–ö–û –ò–ó –ë–ê–ó–´ (price), –µ—Å–ª–∏ –Ω–µ—Ç - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º 0
                let displayPrice = v.price || 0;
                
                let isCancelled = (v.status === "–û—Ç–º–µ–Ω–µ–Ω") || (v.result_status || v.result || "").includes("–û–¢–ú–ï–ù–ï–ù–û");
                let isDone = (v.status === "–í—ã–ø–æ–ª–Ω–µ–Ω") || (v.result_status || v.result || "").includes("–í–´–ü–û–õ–ù–ï–ù–û");
                let cardClass = "v-card";
                if(isCancelled) cardClass += " cancelled";
                if(isDone) cardClass += " done";
                let resText = v.result || "";
                let displayRes = resText.replace("–í–´–ü–û–õ–ù–ï–ù–û", "").replace("–û–¢–ú–ï–ù–ï–ù–û", "").trim().replace(/^,|,$/g, '');
                let resLine = displayRes ? `<div style="background:rgba(242, 186, 201, 0.2); color: var(--dark); padding:10px; border-radius:12px; margin-top:10px; font-weight:bold; font-size:0.9rem;">‚ú® ${displayRes}</div>` : '';
                let vNum = sortedAll.findIndex(ov => ov.id === v.id) + 1;
                
                // –£–ë–†–ê–õ–ò –ö–ù–û–ü–ö–£ –£–î–ê–õ–ï–ù–ò–Ø üóë - —Ç–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –û–¢–ú–ï–ù–£
                let vDate = v.date.split('T')[0]; // YYYY-MM-DD –¥–ª—è input
                let vTime = v.date.split('T')[1] ? v.date.split('T')[1].substring(0, 5) : '00:00';
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è: DD.MM.YYYY
                let vDateDisplay = vDate.split('-').reverse().join('.');
                return `<div class="${cardClass}" onclick="openE(${v.id}, '${v.service.replace(/'/g, "\\'")}', '${(v.comment||"").replace(/'/g, "\\'")}', '${(v.result||"").replace(/'/g, "\\'")}', '${vDate}', '${v.status || 'planned'}')">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div style="font-size:0.85rem; color:var(--hint); margin-bottom:5px;">
                            #${vNum} 
                            <span class="edit-datetime" onclick="event.stopPropagation(); editVisitDateTime(${v.id}, '${vDate}', '${vTime}', '${v.service.replace(/'/g, "\\'")}');" style="cursor:pointer; color:var(--pink); text-decoration:underline;">
                                üìÖ ${vDateDisplay} ‚è∞ ${vTime}
                            </span>
                        </div>
                        <div style="font-size:0.85rem; font-weight:700; color:var(--dark); opacity:0.6;">
                            <span class="edit-price" onclick="event.stopPropagation(); editVisitPrice(${v.id}, ${displayPrice})" style="cursor:pointer; color:var(--pink); text-decoration:underline;">
                                üí∞ ${displayPrice} ‚ÇΩ
                            </span>
                        </div>
                    </div>
                    <div style="font-size:1.1rem; font-weight:800;">üõ† ${v.service}</div> 
                    <div style="margin-top:5px; font-size:0.95rem; color:var(--hint);">${v.comment||'‚Äî'}</div>
                    ${resLine}
                    <div style="margin-top:10px; font-size:0.75rem; font-weight:bold; color:${isDone?'var(--done-green)':(isCancelled?'var(--cancel-red)':'var(--hint)')}">
                        ${isDone ? '‚óè –í–´–ü–û–õ–ù–ï–ù–û' : (isCancelled ? '‚óè –û–¢–ú–ï–ù–ï–ù–û' : '‚óã –û–ñ–ò–î–ê–ï–¢')}
                    </div>
                </div>`;
            }).join('');
            var paid = c.total_paid || 0;
            var debt = plan - paid;
            var debtColor = debt > 0 ? '#ff5252' : '#2e7d32';
            
            var navUrl = "https://yandex.ru/maps/?text=" + encodeURIComponent(c.address || "");
            var calUrl = "https://calendar.google.com/";

            cont.innerHTML = `
                <div class="header-card">
                    <h2>${c.name}</h2>
                    <button class="edit-profile-btn" id="edit-prof-trigger">‚úèÔ∏è –†–ï–î–ê–ö–¢–ò–†–û–í–ê–¢–¨ –ü–†–û–§–ò–õ–¨</button>
                    <div class="info-grid">
                        <div class="info-box"><span class="box-label">–†–µ–±—ë–Ω–æ–∫</span><span class="box-value">üë∂ ${c.child_name || '‚Äî'}</span></div>
                        <div class="info-box"><span class="box-label">–í–æ–∑—Ä–∞—Å—Ç</span><span class="box-value">‚è≥ ${c.child_age || '?'}</span></div>
                        
                        <div class="info-box addr-box" onclick="copyPhone('${formattedPhone}', 'val-ph')">
                            <span class="phone-value-big" id="val-ph">üìû ${formattedPhone}</span>
                        </div>

                        <div class="info-box addr-box" onclick='openAddrDetails(${JSON.stringify(c).replace(/'/g, "&#39;")})'>
                            <span class="box-label">üè† –ê–¥—Ä–µ—Å (–Ω–∞–∂–º–∏ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π)</span>
                            <span class="addr-value">${c.address || '‚Äî'}</span>
                        </div>

                        <div class="info-box b-gold">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <span class="box-label">üí∞ –ö–æ—à–µ–ª—ë–∫</span>
                            </div>
                            <div style="margin-top:5px; font-weight:bold; font-size:0.9rem; color:var(--dark);">–ü–ª–∞–Ω: ${plan}‚ÇΩ</div>
                            <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-top:5px;">
                                <div><div style="font-size:0.7rem; color:var(--hint);">–û–ü–õ–ê–ß–ï–ù–û</div><div style="font-size:1.2rem; font-weight:800; color:#2e7d32;">${paid} ‚ÇΩ</div></div>
                                <div style="text-align:right;"><div style="font-size:0.91rem; color:var(--hint);">–û–°–¢–ê–¢–û–ö</div><div style="font-size:1.56rem; font-weight:800; color:${debtColor};">${debt} ‚ÇΩ</div></div>
                            </div>
                            <button class="money-btn" onclick="openPay()">üíµ –ó–ê–ß–ò–°–õ–ò–¢–¨ –û–ü–õ–ê–¢–£</button>
                        </div>

                        <button class="add-visit-btn" onclick="openAddVisit()">‚ûï –ó–ê–ü–ò–°–ê–¢–¨ –ù–ê –°–ï–ê–ù–°</button>
                        
                        <div class="actions-grid">
                            <a href="tel:+${cleanPhone}" class="action-icon" style="background-image: url('https://raw.githubusercontent.com/shvedjr/Svetlana-Massage-WebApp/main/icons/Phone_31105.png')"></a>
                            <a href="https://max.ru/open" onclick="copyPhone('${formattedPhone}', 'val-ph')" target="_blank" class="action-icon" style="background-image: url('https://raw.githubusercontent.com/shvedjr/Svetlana-Massage-WebApp/main/icons/Max_logo_2025.png')"></a>
                            <a href="https://wa.me/${cleanPhone}" target="_blank" class="action-icon" style="background-image: url('https://raw.githubusercontent.com/shvedjr/Svetlana-Massage-WebApp/main/icons/WhatsApp-Logo.wine.png')"></a>
                            <a href="https://t.me/+${cleanPhone}" target="_blank" class="action-icon" style="background-image: url('https://raw.githubusercontent.com/shvedjr/Svetlana-Massage-WebApp/main/icons/Telegram_Logo.png')"></a>
                            <a href="${navUrl}" target="_blank" class="action-icon" style="background-image: url('https://raw.githubusercontent.com/shvedjr/Svetlana-Massage-WebApp/main/icons/Yandex.Navigator-Logo.wine.png')"></a>
                            <a href="${calUrl}" target="_blank" class="action-icon" style="background-image: url('https://raw.githubusercontent.com/shvedjr/Svetlana-Massage-WebApp/main/icons/Google_Calendar-Logo.wine.png')"></a>
                        </div>
                    </div>
                </div>
                <div class="total-card" onclick="openT(\`${(c.total_result||"").replace(/`/g, "'")}\`)">
                    <span class="box-label">üèÅ –ò—Ç–æ–≥ –∫—É—Ä—Å–∞</span>
                    <div style="margin-top:10px; font-size:1.1rem; font-weight:600;">${c.total_result || '–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –∏—Ç–æ–≥...'}</div>
                </div>
                <h3 style="padding-left:10px; color: var(--dark);">üïí –ò—Å—Ç–æ—Ä–∏—è –≤–∏–∑–∏—Ç–æ–≤</h3>
                ${vHtml}`;
            document.getElementById('edit-prof-trigger').onclick = () => openClientEdit(c);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–Ω–∞—á–æ–∫ –∫—É–±–∫–∞ –µ—Å–ª–∏ –µ—Å—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∫—É—Ä—Å—ã
            const completedCourses = getCompletedCourses(c);
            const trophyBadge = document.getElementById('trophy-badge');
            if (completedCourses.length > 0) {
                trophyBadge.innerHTML = `üèÜ –ü—Ä–æ—à—ë–ª –∫—É—Ä—Å ${completedCourses.join(', ')}`;
                trophyBadge.style.display = 'block';
            } else {
                trophyBadge.style.display = 'none';
            }
            
            document.getElementById('modal').style.display = 'block';
        }

        function openAddVisit() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const mins = String(now.getMinutes()).padStart(2, '0');
            
            document.getElementById('av-date').value = now.toISOString().split('T')[0];
            document.getElementById('av-time').value = `${hours}:${mins}`; // –ü–û–î–°–¢–ê–í–õ–Ø–ï–ú –¢–ï–ö–£–©–ï–ï –í–†–ï–ú–Ø
            document.getElementById('va-price').value = '';
            selectedService = "";
            document.querySelectorAll('#service-tags .tag').forEach(t => t.classList.remove('selected'));
            openEditBox('visit-add-box');
        }

        function selectService(s, el) {
            selectedService = s;
            document.querySelectorAll('#service-tags .tag').forEach(t => t.classList.remove('selected'));
            el.classList.add('selected');
        }

        function saveNewVisit() {
            if (!selectedService) return alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —É—Å–ª—É–≥–∏!");
            const date = document.getElementById('av-date').value;
            const time = document.getElementById('av-time').value;
            const priceInput = document.getElementById('va-price');
            const price = parseFloat(priceInput.value) || 0;
            if (!date || !time) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è!");
            if (price <= 0) {
                priceInput.focus();
                return alert("‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ —Å—Ç–æ–∏–º–æ—Å—Ç—å —Å–µ–∞–Ω—Å–∞!\n\n–¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ 0 ‚ÇΩ");
            }
            
            // –ü–†–û–í–ï–†–ö–ê –î–õ–Ø –ö–£–†–°–ê
            let skipWeekends = false;
            if (selectedService.includes('–ö–£–†–°') || selectedService.includes('–∫—É—Ä—Å')) {
                const selectedDate = new Date(date + 'T' + time);
                const dayOfWeek = selectedDate.getDay(); // 0 = –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ, 1 = –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫
                const dayNames = ['–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ', '–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–≤—Ç–æ—Ä–Ω–∏–∫', '—Å—Ä–µ–¥–∞', '—á–µ—Ç–≤–µ—Ä–≥', '–ø—è—Ç–Ω–∏—Ü–∞', '—Å—É–±–±–æ—Ç–∞'];
                
                // –®–ê–ì 1: –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –≤—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å (—Å—É–±–±–æ—Ç–∞ –∏–ª–∏ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ)
                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    // –í—ã—á–∏—Å–ª—è–µ–º –±–ª–∏–∂–∞–π—à–∏–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫
                    const daysUntilMonday = dayOfWeek === 0 ? 1 : 2;
                    const nextMonday = new Date(selectedDate);
                    nextMonday.setDate(selectedDate.getDate() + daysUntilMonday);
                    const mondayStr = nextMonday.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' });
                    
                    const changeToMonday = confirm(
                        `‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï!\n\n` +
                        `–í—ã –≤—ã–±—Ä–∞–ª–∏ –≤—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å (${dayNames[dayOfWeek]}).\n\n` +
                        `–ö—É—Ä—Å —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –Ω–∞—á–∏–Ω–∞—Ç—å —Å –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞.\n\n` +
                        `–ò–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—É –Ω–∞ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ ${mondayStr}?\n\n` +
                        `–û–ö - –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫\n` +
                        `–û–¢–ú–ï–ù–ê - –æ—Å—Ç–∞–≤–∏—Ç—å ${dayNames[dayOfWeek]}`
                    );
                    
                    if (changeToMonday) {
                        // –ú–µ–Ω—è–µ–º –¥–∞—Ç—É –Ω–∞ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫
                        const year = nextMonday.getFullYear();
                        const month = (nextMonday.getMonth() + 1).toString().padStart(2, '0');
                        const day = nextMonday.getDate().toString().padStart(2, '0');
                        const newDate = `${year}-${month}-${day}`;
                        
                        document.getElementById('av-date').value = newDate;
                        alert(`‚úÖ –î–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ ${mondayStr}`);
                        return; // –í–æ–∑–≤—Ä–∞—Ç –∫ —Ñ–æ—Ä–º–µ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –Ω–æ–≤–æ–π –¥–∞—Ç—ã
                    }
                    
                    // –®–ê–ì 2: –ï—Å–ª–∏ –≤—ã–±—Ä–∞–ª –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –¥–Ω—è
                    skipWeekends = confirm(
                        `üìÖ –†–ï–ñ–ò–ú –ó–ê–ü–ò–°–ò –ö–£–†–°–ê\n\n` +
                        `–í—ã –Ω–∞—á–∏–Ω–∞–µ—Ç–µ –∫—É—Ä—Å —Å ${dayNames[dayOfWeek]}.\n\n` +
                        `–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –≤—ã—Ö–æ–¥–Ω—ã–µ –¥–Ω–∏?\n\n` +
                        `–û–ö - –ø–µ—Ä–≤—ã–π –≤–∏–∑–∏—Ç –ø–µ—Ä–µ–Ω–µ—Å–µ—Ç—Å—è –Ω–∞ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ ${mondayStr}, –∫—É—Ä—Å –ø–æ —Å—Ö–µ–º–µ 5-2-5\n\n` +
                        `–û–¢–ú–ï–ù–ê - –ø–µ—Ä–≤—ã–π –≤–∏–∑–∏—Ç –≤ ${dayNames[dayOfWeek]}, –∫—É—Ä—Å 10 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥`
                    );
                }
                // –ï—Å–ª–∏ –ù–ï –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ (–Ω–æ –∏ –Ω–µ –≤—ã—Ö–æ–¥–Ω–æ–π) - –æ–±—ã—á–Ω–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
                else if (dayOfWeek !== 1) {
                    const confirmedDay = confirm(
                        `‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï!\n\n` +
                        `–í—ã –≤—ã–±—Ä–∞–ª–∏ ${dayNames[dayOfWeek]}, –∞ –Ω–µ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫.\n\n` +
                        `–ù–∞—á–∞—Ç—å –ö–£–†–° —Å —ç—Ç–æ–≥–æ –¥–Ω—è?\n\n` +
                        `–û–ö - –Ω–∞—á–∞—Ç—å —Å ${dayNames[dayOfWeek]}\n` +
                        `–û–¢–ú–ï–ù–ê - –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤—ã–±–æ—Ä—É –¥–∞—Ç—ã`
                    );
                    
                    if (!confirmedDay) {
                        return;
                    }
                    
                    // –°–ø—Ä–∞—à–∏–≤–∞–µ–º –ø—Ä–æ –ø—Ä–æ–ø—É—Å–∫ –≤—ã—Ö–æ–¥–Ω—ã—Ö
                    skipWeekends = confirm(
                        `üìÖ –†–ï–ñ–ò–ú –ó–ê–ü–ò–°–ò –ö–£–†–°–ê\n\n` +
                        `–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –≤—ã—Ö–æ–¥–Ω—ã–µ (—Å—É–±–±–æ—Ç–∞ –∏ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ)?\n\n` +
                        `–û–ö - –∫—É—Ä—Å –ø–æ —Å—Ö–µ–º–µ 5-2-5 (–ø—Ä–æ–ø—É—Å–∫ –≤—ã—Ö–æ–¥–Ω—ã—Ö)\n\n` +
                        `–û–¢–ú–ï–ù–ê - –∫—É—Ä—Å 10 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥ –±–µ–∑ –ø—Ä–æ–ø—É—Å–∫–æ–≤`
                    );
                }
                // –ï—Å–ª–∏ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ - —Ç–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å –æ —Ä–µ–∂–∏–º–µ
                else {
                    skipWeekends = confirm(
                        `üìÖ –†–ï–ñ–ò–ú –ó–ê–ü–ò–°–ò –ö–£–†–°–ê\n\n` +
                        `–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –≤—ã—Ö–æ–¥–Ω—ã–µ (—Å—É–±–±–æ—Ç–∞ –∏ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ)?\n\n` +
                        `–û–ö - –∫—É—Ä—Å –ø–æ —Å—Ö–µ–º–µ 5-2-5 (–ø—Ä–æ–ø—É—Å–∫ –≤—ã—Ö–æ–¥–Ω—ã—Ö)\n\n` +
                        `–û–¢–ú–ï–ù–ê - –∫—É—Ä—Å 10 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥ –±–µ–∑ –ø—Ä–æ–ø—É—Å–∫–æ–≤`
                    );
                }
            }
            
            const btn = document.querySelector('#visit-add-box .save-btn');
            btn.innerText = "–°–û–•–†–ê–ù–Ø–ï–ú..."; btn.style.opacity = "0.5";
            sendToBot({
                action: 'add_new_visit',
                client_id: curC,
                service: selectedService,
                start_date: date,
                start_time: time,
                price: parseFloat(price),
                skip_weekends: skipWeekends
            });
        }

        // –§–£–ù–ö–¶–ò–Ø deleteVisit –£–î–ê–õ–ï–ù–ê - —Ç–µ–ø–µ—Ä—å —É–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –û–¢–ú–ï–ù–£

        function openEditBox(id) {
            document.getElementById('overlay').style.display = 'block';
            document.getElementById(id).style.display = 'block';
        }

        function closeAllEditBoxes() {
            document.getElementById('overlay').style.display = 'none';
            const boxes = ['edit-box', 'total-edit-box', 'client-edit-box', 'pay-box', 'plan-box', 'address-box', 'visit-add-box', 'datetime-edit-box', 'price-edit-box'];
            boxes.forEach(id => document.getElementById(id).style.display = 'none');
        }

        function closeOverlay() {
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º overlay –∏ –≤—Å–µ –æ–∫–Ω–∞
            closeAllEditBoxes();
        }

        function editVisitDateTime(visitId, currentDate, currentTime, service) {
            editingVisitId = visitId;
            editingVisitService = service || "";
            document.getElementById('edit-visit-date').value = currentDate;
            document.getElementById('edit-visit-time').value = currentTime;
            openEditBox('datetime-edit-box');
        }

        function saveVisitDateTime() {
            const newDate = document.getElementById('edit-visit-date').value;
            const newTime = document.getElementById('edit-visit-time').value;
            
            if (!newDate || !newTime) {
                alert("–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è!");
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –≤–∏–∑–∏—Ç —á–∞—Å—Ç—å—é –∫—É—Ä—Å–∞
            const isCourse = editingVisitService.toLowerCase().includes('–∫—É—Ä—Å');
            
            // –ï—Å–ª–∏ —ç—Ç–æ –∫—É—Ä—Å, —Å–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
            if (isCourse) {
                const confirmed = confirm("üîÑ –≠—Ç–æ —Å–µ–∞–Ω—Å –∫—É—Ä—Å–∞!\n\n–°–¥–≤–∏–Ω—É—Ç—å –≤—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ —Å–µ–∞–Ω—Å—ã –∫—É—Ä—Å–∞ –Ω–∞ –Ω–æ–≤—É—é –¥–∞—Ç—É?\n\n‚úÖ –î–ê - —Å–¥–≤–∏–Ω—É—Ç—å –≤—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ —Å–µ–∞–Ω—Å—ã\n‚ùå –ù–ï–¢ - –∏–∑–º–µ–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ —ç—Ç–æ—Ç —Å–µ–∞–Ω—Å");
                if (!confirmed) {
                    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–∞–∑–∞–ª—Å—è –æ—Ç –∞–≤—Ç–æ—Å–¥–≤–∏–≥–∞
                    const btn = document.querySelector('#datetime-edit-box .save-btn');
                    btn.innerText = "–°–û–•–†–ê–ù–Ø–ï–ú..."; btn.style.opacity = "0.5";
                    
                    sendToBot({
                        action: 'edit_visit_datetime',
                        visit_id: editingVisitId,
                        client_id: curC,
                        new_date: newDate,
                        new_time: newTime,
                        is_course: false
                    });
                    return;
                }
                
                // –ù–∞—Ö–æ–¥–∏–º —Ç–µ–∫—É—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –∏ –µ–≥–æ –≤–∏–∑–∏—Ç—ã
                const currentClient = allClients.find(c => c.id === curC);
                if (!currentClient) {
                    alert("–û—à–∏–±–∫–∞: –∫–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω");
                    return;
                }
                
                // –ù–∞—Ö–æ–¥–∏–º —Ç–µ–∫—É—â–∏–π –≤–∏–∑–∏—Ç
                const currentVisit = currentClient.visits.find(v => v.id === editingVisitId);
                if (!currentVisit) {
                    alert("–û—à–∏–±–∫–∞: –≤–∏–∑–∏—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω");
                    return;
                }
                
                // –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö —Å–µ–∞–Ω—Å–æ–≤ —Ç–æ–≥–æ –∂–µ –∫—É—Ä—Å–∞
                const currentVisitDate = new Date(currentVisit.date);
                const nextVisitsCount = currentClient.visits.filter(v => 
                    v.service === editingVisitService && 
                    new Date(v.date) > currentVisitDate &&
                    v.status !== '–û—Ç–º–µ–Ω–µ–Ω'
                ).length;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–ø–∞–¥–∞—é—Ç –ª–∏ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ —Å–µ–∞–Ω—Å—ã –Ω–∞ –≤—ã—Ö–æ–¥–Ω—ã–µ
                const selectedDate = new Date(newDate);
                let hasWeekends = false;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–ª–µ–¥—É—é—â–∏–µ N –¥–Ω–µ–π, –≥–¥–µ N = –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä–µ–Ω–æ—Å–∏–º—ã—Ö —Å–µ–∞–Ω—Å–æ–≤
                for (let i = 1; i <= nextVisitsCount; i++) {
                    const checkDate = new Date(selectedDate);
                    checkDate.setDate(checkDate.getDate() + i);
                    const dayOfWeek = checkDate.getDay();
                    if (dayOfWeek === 0 || dayOfWeek === 6) {
                        hasWeekends = true;
                        break;
                    }
                }
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å –≤—ã—Ö–æ–¥–Ω—ã–µ, —Å–ø—Ä–∞—à–∏–≤–∞–µ–º —Å—Ö–µ–º—É –ø–µ—Ä–µ–Ω–æ—Å–∞
                let skipWeekends = false;
                if (hasWeekends) {
                    skipWeekends = confirm("üìÖ –°—Ö–µ–º–∞ –ø–µ—Ä–µ–Ω–æ—Å–∞ —Å–µ–∞–Ω—Å–æ–≤:\n\n‚úÖ –î–ê - –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å –≤—ã—Ö–æ–¥–Ω—ã–µ (—Å—Ö–µ–º–∞ 5-2-5)\n‚ùå –ù–ï–¢ - –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å –ø–æ–¥—Ä—è–¥, –≤–∫–ª—é—á–∞—è –≤—ã—Ö–æ–¥–Ω—ã–µ");
                }
                
                const btn = document.querySelector('#datetime-edit-box .save-btn');
                btn.innerText = "–°–û–•–†–ê–ù–Ø–ï–ú..."; btn.style.opacity = "0.5";
                
                sendToBot({
                    action: 'edit_visit_datetime',
                    visit_id: editingVisitId,
                    client_id: curC,
                    new_date: newDate,
                    new_time: newTime,
                    is_course: true,
                    skip_weekends: skipWeekends
                });
                return;
            }
            
            const btn = document.querySelector('#datetime-edit-box .save-btn');
            btn.innerText = "–°–û–•–†–ê–ù–Ø–ï–ú..."; btn.style.opacity = "0.5";
            
            sendToBot({
                action: 'edit_visit_datetime',
                visit_id: editingVisitId,
                client_id: curC,
                new_date: newDate,
                new_time: newTime,
                is_course: false
            });
        }

        function editVisitPrice(visitId, currentPrice) {
            editingVisitId = visitId;
            document.getElementById('edit-visit-price').value = currentPrice;
            openEditBox('price-edit-box');
        }

        function saveVisitPrice() {
            const newPrice = parseFloat(document.getElementById('edit-visit-price').value);
            
            if (!newPrice || newPrice <= 0) {
                alert("‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ —Å—Ç–æ–∏–º–æ—Å—Ç—å —Å–µ–∞–Ω—Å–∞!\n\n–¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ 0 ‚ÇΩ");
                return;
            }
            
            const btn = document.querySelector('#price-edit-box .save-btn');
            btn.innerText = "–°–û–•–†–ê–ù–Ø–ï–ú..."; btn.style.opacity = "0.5";
            
            sendToBot({
                action: 'edit_visit_price',
                visit_id: editingVisitId,
                client_id: curC,
                new_price: newPrice
            });
        }

        function openE(id, service, comm, res, date, status) { 
            curV = id; 
            curService = service;
            curVisitStatus = status || 'planned'; // –°–û–•–†–ê–ù–Ø–ï–ú –¢–ï–ö–£–©–ò–ô –°–¢–ê–¢–£–°
            document.getElementById('e-title').innerText = `üõ† ${service} (${date})`;
            document.getElementById('e-comm').value = comm; 
            curEditStatus = "";
            if(res.includes("–í–´–ü–û–õ–ù–ï–ù–û") || status === "–í—ã–ø–æ–ª–Ω–µ–Ω") curEditStatus = "–í–´–ü–û–õ–ù–ï–ù–û";
            if(res.includes("–û–¢–ú–ï–ù–ï–ù–û") || status === "–û—Ç–º–µ–Ω–µ–Ω") curEditStatus = "–û–¢–ú–ï–ù–ï–ù–û";
            document.getElementById('e-res').value = res.replace("–í–´–ü–û–õ–ù–ï–ù–û", "").replace("–û–¢–ú–ï–ù–ï–ù–û", "").trim().replace(/^,|,$/g, '');
            const tags = ['üòä –°–ø–æ–∫–æ–µ–Ω', 'üò¢ –ü–ª–∞–∫–∞–ª', '‚ú® –ü—Ä–æ–≥—Ä–µ—Å—Å', 'üí§ –°–ø–∞–ª', 'ü¶ñ –ê–∫—Ç–∏–≤–Ω–∏—á–∞–ª'];
            document.getElementById('tags-container').innerHTML = tags.map(t => `<span class="tag" onclick="addTag('${t}')">${t}</span>`).join('');
            updateEditStatusUI();
            openEditBox('edit-box'); 
        }

        function toggleEditStatus(status) {
            curEditStatus = (curEditStatus === status) ? "" : status;
            updateEditStatusUI();
        }

        function updateEditStatusUI() {
            const bDone = document.getElementById('eb-done');
            const bCancel = document.getElementById('eb-cancel');
            bDone.className = "st-btn " + (curEditStatus === '–í–´–ü–û–õ–ù–ï–ù–û' ? "active-done" : (curEditStatus === '–û–¢–ú–ï–ù–ï–ù–û' ? "inactive" : ""));
            bCancel.className = "st-btn " + (curEditStatus === '–û–¢–ú–ï–ù–ï–ù–û' ? "active-cancel" : (curEditStatus === '–í–´–ü–û–õ–ù–ï–ù–û' ? "inactive" : ""));
        }

        function addTag(t) { 
            var i = document.getElementById('e-res'); 
            i.value = i.value ? i.value + ', ' + t : t; 
        }

        function saveE() { 
            const btn = document.querySelector('#edit-box .save-btn');
            
            // –ü–†–û–í–ï–†–ö–ê: –µ—Å–ª–∏ –æ—Ç–º–µ–Ω—è–µ–º, –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø—Ä–∏—á–∏–Ω–∞
            if (curEditStatus === '–û–¢–ú–ï–ù–ï–ù–û') {
                const reason = document.getElementById('e-res').value.trim();
                if (!reason) {
                    alert("‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–º–µ–Ω—ã –≤ –ø–æ–ª–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞!");
                    return;
                }
            }
            
            btn.innerText = "–°–û–•–†–ê–ù–Ø–ï–ú..."; btn.style.opacity = "0.5";
            let finalRes = document.getElementById('e-res').value.trim();
            if(curEditStatus) finalRes = curEditStatus + (finalRes ? ", " + finalRes : "");
            const client = allClients.find(c => c.id === curC);
            let displayTitle = document.getElementById('e-title').innerText;
            let sessionInfo = displayTitle.replace('üõ† ', '').split(' (')[0];
            
            sendToBot({ 
                action: 'edit_visit', 
                visit_id: curV, 
                client_id: curC, 
                name: client ? client.name : "–ö–ª–∏–µ–Ω—Ç", 
                session_display: sessionInfo, 
                comment: document.getElementById('e-comm').value, 
                result: finalRes, 
                status_only: curEditStatus,
                old_status: curVisitStatus // –û–¢–ü–†–ê–í–õ–Ø–ï–ú –°–¢–ê–†–´–ô –°–¢–ê–¢–£–° –î–õ–Ø –ü–†–û–í–ï–†–ö–ò
            });
        }

        function openPay() {
            document.getElementById('pay-amount').value = '';
            openEditBox('pay-box');
        }

        function openPlan(currentPlan) {
            document.getElementById('plan-amount').value = currentPlan;
            openEditBox('plan-box');
        }

        function openClientEdit(c) {
            document.getElementById('ec-name').value = c.name;
            document.getElementById('ec-phone').value = c.phone || '';
            document.getElementById('ec-child').value = c.child_name || '';
            document.getElementById('ec-age').value = c.child_age || '';
            document.getElementById('ec-addr').value = c.address || '';
            document.getElementById('ec-entrance').value = c.entrance || '';
            document.getElementById('ec-floor').value = c.floor || '';
            document.getElementById('ec-intercom').value = c.intercom || '';
            document.getElementById('ec-addr-comm').value = c.address_comment || '';
            openEditBox('client-edit-box');
        }

        function openT(v) { 
            document.getElementById('e-total').value = v; 
            openEditBox('total-edit-box'); 
        }
        
        function sendToBot(data) {
            try { tg.sendData(JSON.stringify(data)); } catch (e) {}
            setTimeout(() => { tg.close(); }, 300);
        }

        function savePay() {
            const amount = document.getElementById('pay-amount').value;
            if(!amount) return alert("–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É");
            const btn = document.querySelector('#pay-box .save-btn');
            btn.innerText = "–ó–ê–ß–ò–°–õ–Ø–ï–ú..."; btn.style.opacity = "0.5";
            sendToBot({ action: 'add_payment', client_id: curC, amount: parseFloat(amount) });
        }

        function savePlan() {
            const amount = document.getElementById('plan-amount').value;
            if(!amount || amount < 0) return alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É");
            const btn = document.querySelector('#plan-box .save-btn');
            btn.innerText = "–û–ë–ù–û–í–õ–Ø–ï–ú..."; btn.style.opacity = "0.5";
            sendToBot({ action: 'edit_plan', client_id: curC, amount: parseFloat(amount) });
        }

        function saveT() { 
            const btn = document.querySelector('#total-edit-box .save-btn');
            btn.innerText = "–°–û–•–†–ê–ù–Ø–ï–ú..."; btn.style.opacity = "0.5";
            sendToBot({ action: 'edit_total', client_id: curC, total_result: document.getElementById('e-total').value });
        }

        function saveClient() {
            // –í–ê–õ–ò–î–ê–¶–ò–Ø –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–• –ü–û–õ–ï–ô
            const name = document.getElementById('ec-name').value.trim();
            const phone = document.getElementById('ec-phone').value.trim();
            const childName = document.getElementById('ec-child').value.trim();
            const childAge = document.getElementById('ec-age').value.trim();
            const address = document.getElementById('ec-addr').value.trim();
            
            if (!phone) {
                tg.showAlert("‚ùå –£–∫–∞–∂–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω");
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
            const phoneDigits = phone.replace(/\D/g, '');
            if (phoneDigits.length !== 11 || !phoneDigits.startsWith('7')) {
                tg.showAlert("‚ùå –¢–µ–ª–µ—Ñ–æ–Ω –≤–≤–µ–¥–µ–Ω –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ. –î–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ñ–æ—Ä–º–∞—Ç +7XXXXXXXXXX (11 —Ü–∏—Ñ—Ä)");
                return;
            }
            
            if (!name) {
                tg.showAlert("‚ùå –£–∫–∞–∂–∏—Ç–µ –∏–º—è —Ä–æ–¥–∏—Ç–µ–ª—è/–∫–ª–∏–µ–Ω—Ç–∞");
                return;
            }
            
            if (!address) {
                tg.showAlert("‚ùå –£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å");
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –¥–µ—Ç—Å–∫–æ–≥–æ –º–∞—Å—Å–∞–∂–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –æ —Ä–µ–±–µ–Ω–∫–µ)
            const currentClient = allClients.find(c => c.id === curC);
            if (currentClient && currentClient.service_type !== 'adult') {
                if (!childName) {
                    tg.showAlert("‚ùå –£–∫–∞–∂–∏—Ç–µ –∏–º—è —Ä–µ–±–µ–Ω–∫–∞");
                    return;
                }
                if (!childAge) {
                    tg.showAlert("‚ùå –£–∫–∞–∂–∏—Ç–µ –≤–æ–∑—Ä–∞—Å—Ç —Ä–µ–±–µ–Ω–∫–∞");
                    return;
                }
            }
            
            const btn = document.querySelector('#client-edit-box .save-btn');
            btn.innerText = "–û–ë–ù–û–í–õ–Ø–ï–ú..."; btn.style.opacity = "0.5";
            sendToBot({ 
                action: 'edit_client', client_id: curC, name: name, phone: phone, 
                child_name: childName, child_age: childAge, address: address,
                entrance: document.getElementById('ec-entrance').value, floor: document.getElementById('ec-floor').value, intercom: document.getElementById('ec-intercom').value,
                address_comment: document.getElementById('ec-addr-comm').value
            });
        }

        function askDelete() {
            tg.showConfirm("–í–Ω–∏–º–∞–Ω–∏–µ! –í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∫–∞—Ä—Ç–æ—á–∫—É?", (confirm) => {
                if (confirm) sendToBot({ action: 'delete_client', client_id: curC });
            });
        }

        function closeM() { 
            document.getElementById('modal').style.display = 'none'; 
            window.location.hash = '';
        }

        loadData();
    </script>
</body>
</html>

