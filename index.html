<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Svetlana Massage ‚Äî Terminal</title>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@700&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { 
            --bg-color: #fcf1f1; 
            --accent-pink: #f2bac9; 
            --text-dark: #4a4444; 
            --input-border: #f0e2e2; 
            --white: #ffffff; 
            --input-bg: #ffffff;
            --label-color: #5b4d42;
            --card-shadow: 0 10px 30px rgba(224, 159, 176, 0.2);
        }
        
        body { font-family: -apple-system, sans-serif; background-color: var(--bg-color); margin: 0; padding: 15px; min-height: 100vh; color: var(--text-dark); }
        .brand-header { text-align: center; font-family: 'Caveat', cursive; font-size: 2.2rem; color: #e09fb0; margin-bottom: 15px; text-shadow: 1px 1px 2px rgba(0,0,0,0.05); }
        .card { background: var(--white); border-radius: 30px; padding: 24px; box-shadow: var(--card-shadow); border: 1px solid rgba(242, 186, 201, 0.3); }
        .grid-services { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        
        .service-btn { 
            background: var(--input-bg); 
            border: 2px solid var(--input-border); 
            color: var(--text-dark);
            padding: 16px 5px; border-radius: 18px; text-align: center; font-weight: 800; cursor: pointer; transition: all 0.2s ease; 
        }
        .service-btn.active { background: var(--accent-pink); color: white; border-color: var(--accent-pink); box-shadow: 0 4px 12px rgba(242, 186, 201, 0.4); }
        
        .child-section { background: rgba(242, 186, 201, 0.05); padding: 18px; border-radius: 22px; margin-bottom: 18px; border: 2px dashed var(--accent-pink); }
        .input-group { margin-bottom: 18px; }
        
        label { display: block; margin-bottom: 8px; font-weight: 800; color: var(--label-color); font-size: 0.95rem; }
        
        input, textarea, select { 
            width: 100%; padding: 16px; 
            border: 2px solid var(--input-border); 
            border-radius: 16px; font-size: 1rem; box-sizing: border-box; outline: none; 
            background: var(--input-bg); color: var(--text-dark); transition: border-color 0.2s;
        }
        input:focus, textarea:focus, select:focus { border-color: var(--accent-pink); }
        
        .main-button { background-color: #5b4d42; color: white; border: none; padding: 22px; border-radius: 20px; width: 100%; font-size: 1.2rem; font-weight: 900; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 6px 15px rgba(91, 77, 66, 0.2); text-transform: uppercase; letter-spacing: 0.5px; }
        .shved-footer { text-align: center; margin-top: 25px; color: #d6abb6; font-size: 0.85rem; font-style: italic; }
        .main-button:active { transform: scale(0.97); opacity: 0.9; }
        
        .calendar-link { 
            display: flex; align-items: center; justify-content: center; gap: 8px;
            text-decoration: none; background: var(--input-bg); border: 2px solid #aec6cf; 
            padding: 14px; border-radius: 18px; color: #72909a; font-weight: 800; 
            margin-bottom: 18px; transition: all 0.2s ease; 
        }
        .calendar-link:active { transform: scale(0.98); background: rgba(174, 198, 207, 0.1); }

        input::-webkit-calendar-picker-indicator {
            filter: grayscale(1) opacity(0.5);
        }
    </style>
</head>
<body>
    <div class="brand-header">–°–≤–µ—Ç–∞ –¥–µ—Ç—Å–∫–∏–π –º–∞—Å—Å–∞–∂</div>
    <div class="card">
        <div class="grid-services">
            <div class="service-btn" onclick="select(this)">–ö—É—Ä—Å</div>
            <div class="service-btn" onclick="select(this)">–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è</div>
            <div class="service-btn" onclick="select(this)">–í–∑—Ä–æ—Å–ª—ã–π</div>
            <div class="service-btn active" onclick="select(this)">–î–µ—Ç—Å–∫–∏–π</div>
        </div>
        <div class="input-group"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input type="tel" id="phone" placeholder="+79001112233" maxlength="12"></div>
        <div class="input-group"><label id="p_label">–ò–º—è —Ä–æ–¥–∏—Ç–µ–ª—è</label><input type="text" id="p_name" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è"></div>
        <div id="child_block" class="child-section">
            <div class="input-group"><label>–ò–º—è —Ä–µ–±–µ–Ω–∫–∞</label><input type="text" id="c_name" placeholder="–ö–∞–∫ –∑–æ–≤—É—Ç?"></div>
            <div class="input-group" style="margin:0;"><label>–í–æ–∑—Ä–∞—Å—Ç</label><input type="text" id="c_age" placeholder="–ø—Ä–∏–º–µ—Ä: 6 –º–µ—Å—è—Ü–µ–≤"></div>
        </div>
        <div class="input-group"><label>–ê–¥—Ä–µ—Å</label><input type="text" id="addr" placeholder="–ì–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, –¥–æ–º"></div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 18px;">
            <div>
                <label>–ü–æ–¥—ä–µ–∑–¥</label>
                <input type="number" id="entrance" placeholder="‚Ññ" style="margin-bottom: 0;" inputmode="numeric" pattern="[0-9]*">
            </div>
            <div>
                <label>–≠—Ç–∞–∂</label>
                <input type="number" id="floor" placeholder="‚Ññ" style="margin-bottom: 0;" inputmode="numeric" pattern="[0-9]*">
            </div>
            <div>
                <label>–î–æ–º–æ—Ñ–æ–Ω</label>
                <input type="text" id="intercom" placeholder="–ö–æ–¥" style="margin-bottom: 0;">
            </div>
        </div>
        
        <div class="input-group"><label>–ó–∞–º–µ—Ç–∫–∞ –∫ –∞–¥—Ä–µ—Å—É</label><input type="text" id="addr_comment" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∑–µ–ª–µ–Ω–∞—è –¥–≤–µ—Ä—å"></div>
        
        <div class="input-group">
            <label>–û—Ç–∫—É–¥–∞ —É–∑–Ω–∞–ª–∏?</label>
            <select id="source">
                <option value="–ù–µ —É–∫–∞–∑–∞–Ω–æ">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
                <option value="–°–∞—Ä–∞—Ñ–∞–Ω–Ω–æ–µ —Ä–∞–¥–∏–æ">–°–∞—Ä–∞—Ñ–∞–Ω–Ω–æ–µ —Ä–∞–¥–∏–æ</option>
                <option value="–ò–Ω—Å—Ç–∞–≥—Ä–∞–º">–ò–Ω—Å—Ç–∞–≥—Ä–∞–º</option>
                <option value="–í–ö">–í–ö</option>
                <option value="–¢–µ–ª–µ–≥—Ä–∞–º">–¢–µ–ª–µ–≥—Ä–∞–º</option>
            </select>
        </div>

        <div class="input-group">
            <label>–°—Ç–æ–∏–º–æ—Å—Ç—å –æ–¥–Ω–æ–≥–æ —Å–µ–∞–Ω—Å–∞ (–ø–ª–∞–Ω)</label>
            <input type="number" id="contract_sum" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 2000" inputmode="numeric">
        </div>

        <a href="https://calendar.google.com/calendar/r/day" target="_blank" class="calendar-link">
            <span>üìÖ –û—Ç–∫—Ä—ã—Ç—å Google –ö–∞–ª–µ–Ω–¥–∞—Ä—å</span>
        </a>

        <div class="input-group"><label>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</label><input type="datetime-local" id="dt"></div>
        <div class="input-group"><label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label><textarea id="comm" rows="2"></textarea></div>
        <button class="main-button" id="submitBtn" onclick="send()">–í–ù–ï–°–¢–ò –ó–ê–ü–ò–°–¨</button>
    </div>

    <div class="shved-footer">–°–æ–∑–¥–∞–Ω–æ —Å –ª—é–±–æ–≤—å—é –æ—Ç shvedjr</div>

    <script>
        let tg = window.Telegram.WebApp; 
        tg.ready();
        tg.expand();

        let allClients = [];

        document.getElementById('phone').addEventListener('input', function (e) {
            // –£–¥–∞–ª—è–µ–º –≤—Å–µ –Ω–µ—Ü–∏—Ñ—Ä–æ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã (–≤–∫–ª—é—á–∞—è +, –ø—Ä–æ–±–µ–ª—ã, —Å–∫–æ–±–∫–∏ –∏ —Ç.–¥.)
            let x = e.target.value.replace(/\D/g, ''); 
            
            // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –≤–≤–µ–¥–µ–Ω–æ - –æ—á–∏—â–∞–µ–º –ø–æ–ª–µ
            if (x.length === 0) {
                e.target.value = '';
                return;
            }
            
            // –ï—Å–ª–∏ –ø–µ—Ä–≤–∞—è —Ü–∏—Ñ—Ä–∞ 8 - –∑–∞–º–µ–Ω—è–µ–º –Ω–∞ 7
            if (x.startsWith('8')) {
                x = '7' + x.substring(1);
            }
            // –ï—Å–ª–∏ –ø–µ—Ä–≤–∞—è —Ü–∏—Ñ—Ä–∞ –ù–ï 7 - –¥–æ–±–∞–≤–ª—è–µ–º 7 –≤ –Ω–∞—á–∞–ª–æ
            else if (!x.startsWith('7')) {
                x = '7' + x;
            }
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É –¥–æ 11 —Ü–∏—Ñ—Ä (7 + 10 —Ü–∏—Ñ—Ä –Ω–æ–º–µ—Ä–∞)
            x = x.substring(0, 11); 
            
            // –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å +
            e.target.value = '+' + x;

            if (x.length === 11) {
                const dup = allClients.find(c => c.phone && c.phone.replace(/\D/g, '') === x);
                if (dup) {
                    if (!document.getElementById('p_name').value) document.getElementById('p_name').value = dup.name || '';
                    if (!document.getElementById('c_name').value) document.getElementById('c_name').value = dup.child_name || '';
                    if (!document.getElementById('c_age').value) document.getElementById('c_age').value = dup.child_age || '';
                    if (!document.getElementById('addr').value) {
                        let a = dup.address || '';
                        document.getElementById('addr').value = a.includes('text=') ? decodeURIComponent(a.split('text=')[1]) : a;
                    }
                    if (!document.getElementById('entrance').value) document.getElementById('entrance').value = dup.entrance || '';
                    if (!document.getElementById('floor').value) document.getElementById('floor').value = dup.floor || '';
                    if (!document.getElementById('intercom').value) document.getElementById('intercom').value = dup.intercom || '';
                    if (!document.getElementById('addr_comment').value) document.getElementById('addr_comment').value = dup.address_comment || '';
                    tg.HapticFeedback.notificationOccurred('success');
                }
            }
        });
        
        function select(el) {
            document.querySelectorAll('.service-btn').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
            const isV = el.innerText === "–í–∑—Ä–æ—Å–ª—ã–π";
            document.getElementById('child_block').style.display = isV ? "none" : "block";
            document.getElementById('p_label').innerText = isV ? "–§–ò–û –ö–ª–∏–µ–Ω—Ç–∞" : "–ò–º—è —Ä–æ–¥–∏—Ç–µ–ª—è";
        }

        function getDuration(service, ageStr) {
            const s = service.toLowerCase();
            const age = ageStr.toLowerCase();
            if (s === "–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è" || s === "–≤–∑—Ä–æ—Å–ª—ã–π") return 60;
            if (s === "–∫—É—Ä—Å" || s === "–¥–µ—Ç—Å–∫–∏–π") {
                const hasYear = age.includes('–≥–æ–¥') || age.includes('–ª–µ—Ç');
                const hasInfantUnits = age.includes('–º–µ—Å') || age.includes('–Ω–µ–¥') || age.includes('–¥–Ω');
                const numMatch = age.match(/\d+/);
                const num = numMatch ? parseInt(numMatch[0]) : 0;
                if (hasYear && num >= 1) return 40;
                if (hasInfantUnits) return 30;
                if (num >= 1 && !hasInfantUnits) return 40;
                return 30;
            }
            return 30;
        }

        function send() {
            const btn = document.getElementById('submitBtn');
            const serviceName = document.querySelector('.service-btn.active').innerText;
            const ageValue = document.getElementById('c_age').value.trim();
            const rawAddr = document.getElementById('addr').value.trim();
            const dateTimeValue = document.getElementById('dt').value;
            
            const d = { 
                service: serviceName, 
                parent_name: document.getElementById('p_name').value.trim(), 
                phone: document.getElementById('phone').value.trim(), 
                address: rawAddr,
                entrance: document.getElementById('entrance').value.trim(),
                floor: document.getElementById('floor').value.trim(),
                intercom: document.getElementById('intercom').value.trim(),
                address_comment: document.getElementById('addr_comment').value.trim(),
                datetime: dateTimeValue, 
                comment: document.getElementById('comm').value.trim(), 
                child_name: document.getElementById('c_name').value.trim(), 
                child_age: ageValue,
                source: document.getElementById('source').value,
                contract_sum: document.getElementById('contract_sum').value || 0,
                duration: getDuration(serviceName, ageValue)
            };
            
            // –í–ê–õ–ò–î–ê–¶–ò–Ø –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–• –ü–û–õ–ï–ô
            if (!d.phone) {
                tg.showAlert("‚ùå –£–∫–∞–∂–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω");
                return;
            }
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å +7 –∏ 10 —Ü–∏—Ñ—Ä)
            const phoneDigits = d.phone.replace(/\D/g, '');
            if (phoneDigits.length !== 11 || !phoneDigits.startsWith('7')) {
                tg.showAlert("‚ùå –¢–µ–ª–µ—Ñ–æ–Ω –≤–≤–µ–¥–µ–Ω –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ. –î–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ñ–æ—Ä–º–∞—Ç +7XXXXXXXXXX (11 —Ü–∏—Ñ—Ä)");
                return;
            }
            if (!d.parent_name) {
                tg.showAlert("‚ùå –£–∫–∞–∂–∏—Ç–µ –∏–º—è —Ä–æ–¥–∏—Ç–µ–ª—è/–∫–ª–∏–µ–Ω—Ç–∞");
                return;
            }
            if (!d.address) {
                tg.showAlert("‚ùå –£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å");
                return;
            }
            if (!d.datetime) {
                tg.showAlert("‚ùå –£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è");
                return;
            }
            
            // –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è –¥–µ—Ç—Å–∫–æ–≥–æ –º–∞—Å—Å–∞–∂–∞
            if (serviceName !== "–í–∑—Ä–æ—Å–ª—ã–π") {
                if (!d.child_name) {
                    tg.showAlert("‚ùå –£–∫–∞–∂–∏—Ç–µ –∏–º—è —Ä–µ–±–µ–Ω–∫–∞");
                    return;
                }
                if (!d.child_age) {
                    tg.showAlert("‚ùå –£–∫–∞–∂–∏—Ç–µ –≤–æ–∑—Ä–∞—Å—Ç —Ä–µ–±–µ–Ω–∫–∞");
                    return;
                }
            }
            
            // –ü–†–û–í–ï–†–ö–ê –î–õ–Ø –ö–£–†–°–ê
            if (serviceName === "–ö—É—Ä—Å") {
                const selectedDate = new Date(dateTimeValue);
                const dayOfWeek = selectedDate.getDay(); // 0 = –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ, 1 = –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫
                const dayNames = ['–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ', '–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–≤—Ç–æ—Ä–Ω–∏–∫', '—Å—Ä–µ–¥–∞', '—á–µ—Ç–≤–µ—Ä–≥', '–ø—è—Ç–Ω–∏—Ü–∞', '—Å—É–±–±–æ—Ç–∞'];
                
                // –®–ê–ì 1: –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –≤—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å (—Å—É–±–±–æ—Ç–∞ –∏–ª–∏ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ)
                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    // –í—ã—á–∏—Å–ª—è–µ–º –±–ª–∏–∂–∞–π—à–∏–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫
                    const daysUntilMonday = dayOfWeek === 0 ? 1 : 2;
                    const nextMonday = new Date(selectedDate);
                    nextMonday.setDate(selectedDate.getDate() + daysUntilMonday);
                    const mondayStr = nextMonday.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' });
                    
                    const changeToMonday = confirm(
                        `‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï!\n\n` +
                        `–í—ã –≤—ã–±—Ä–∞–ª–∏ –≤—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å (${dayNames[dayOfWeek]}).\n\n` +
                        `–ö—É—Ä—Å —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –Ω–∞—á–∏–Ω–∞—Ç—å —Å –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞.\n\n` +
                        `–ù–∞–∂–º–∏—Ç–µ –û–ö —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—É –Ω–∞ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ ${mondayStr}\n` +
                        `–ù–∞–∂–º–∏—Ç–µ –û–¢–ú–ï–ù–ê —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å ${dayNames[dayOfWeek]}`
                    );
                    
                    if (changeToMonday) {
                        // –ú–µ–Ω—è–µ–º –¥–∞—Ç—É –Ω–∞ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫
                        const hours = selectedDate.getHours().toString().padStart(2, '0');
                        const minutes = selectedDate.getMinutes().toString().padStart(2, '0');
                        const year = nextMonday.getFullYear();
                        const month = (nextMonday.getMonth() + 1).toString().padStart(2, '0');
                        const day = nextMonday.getDate().toString().padStart(2, '0');
                        const newDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
                        
                        document.getElementById('dt').value = newDateTime;
                        d.datetime = newDateTime;
                        
                        tg.showAlert(`‚úÖ –î–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ ${mondayStr}`);
                        return; // –í–æ–∑–≤—Ä–∞—Ç –∫ —Ñ–æ—Ä–º–µ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –Ω–æ–≤–æ–π –¥–∞—Ç—ã
                    }
                    
                    // –®–ê–ì 2: –ï—Å–ª–∏ –≤—ã–±—Ä–∞–ª –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –¥–Ω—è
                    const skipWeekends = confirm(
                        `üìÖ –†–ï–ñ–ò–ú –ó–ê–ü–ò–°–ò –ö–£–†–°–ê\n\n` +
                        `–í—ã –Ω–∞—á–∏–Ω–∞–µ—Ç–µ –∫—É—Ä—Å —Å ${dayNames[dayOfWeek]}.\n\n` +
                        `–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –≤—ã—Ö–æ–¥–Ω—ã–µ?\n\n` +
                        `–î–ê - –ø–µ—Ä–≤—ã–π –≤–∏–∑–∏—Ç –±—É–¥–µ—Ç –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω –Ω–∞ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ ${mondayStr}, –∫—É—Ä—Å –ø–æ —Å—Ö–µ–º–µ 5-2-5\n` +
                        `–ù–ï–¢ - –ø–µ—Ä–≤—ã–π –≤–∏–∑–∏—Ç –≤ ${dayNames[dayOfWeek]}, –∫—É—Ä—Å 10 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥`
                    );
                    
                    d.skip_weekends = skipWeekends;
                }
                // –ï—Å–ª–∏ –ù–ï –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ (–Ω–æ –∏ –Ω–µ –≤—ã—Ö–æ–¥–Ω–æ–π) - –æ–±—ã—á–Ω–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
                else if (dayOfWeek !== 1) {
                    const confirmedDay = confirm(
                        `‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï!\n\n` +
                        `–í—ã –≤—ã–±—Ä–∞–ª–∏ ${dayNames[dayOfWeek]}, –∞ –Ω–µ –ø–µ—Ä–≤—ã–π –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ (–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫).\n\n` +
                        `–í—ã —Ç–æ—á–Ω–æ —Ö–æ—Ç–∏—Ç–µ –Ω–∞—á–∞—Ç—å –ö–£–†–° —Å —ç—Ç–æ–≥–æ –¥–Ω—è?`
                    );
                    
                    if (!confirmedDay) {
                        return;
                    }
                    
                    // –°–ø—Ä–∞—à–∏–≤–∞–µ–º –ø—Ä–æ –ø—Ä–æ–ø—É—Å–∫ –≤—ã—Ö–æ–¥–Ω—ã—Ö
                    const skipWeekends = confirm(
                        `üìÖ –†–ï–ñ–ò–ú –ó–ê–ü–ò–°–ò –ö–£–†–°–ê\n\n` +
                        `–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –≤—ã—Ö–æ–¥–Ω—ã–µ (—Å—É–±–±–æ—Ç–∞ –∏ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ)?\n\n` +
                        `–î–ê - –∫—É—Ä—Å –ø–æ —Å—Ö–µ–º–µ 5-2-5 (–ø—Ä–æ–ø—É—Å–∫ –≤—ã—Ö–æ–¥–Ω—ã—Ö)\n` +
                        `–ù–ï–¢ - –∫—É—Ä—Å 10 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥ –±–µ–∑ –ø—Ä–æ–ø—É—Å–∫–æ–≤`
                    );
                    
                    d.skip_weekends = skipWeekends;
                }
                // –ï—Å–ª–∏ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ - —Ç–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å –æ —Ä–µ–∂–∏–º–µ
                else {
                    const skipWeekends = confirm(
                        `üìÖ –†–ï–ñ–ò–ú –ó–ê–ü–ò–°–ò –ö–£–†–°–ê\n\n` +
                        `–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –≤—ã—Ö–æ–¥–Ω—ã–µ (—Å—É–±–±–æ—Ç–∞ –∏ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ)?\n\n` +
                        `–î–ê - –∫—É—Ä—Å –ø–æ —Å—Ö–µ–º–µ 5-2-5 (–ø—Ä–æ–ø—É—Å–∫ –≤—ã—Ö–æ–¥–Ω—ã—Ö)\n` +
                        `–ù–ï–¢ - –∫—É—Ä—Å 10 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥ –±–µ–∑ –ø—Ä–æ–ø—É—Å–∫–æ–≤`
                    );
                    
                    d.skip_weekends = skipWeekends;
                }
            }

            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('edit_data')) { d.is_fix = true; }

            btn.innerText = "–°–û–•–†–ê–ù–Ø–Æ...";
            btn.style.backgroundColor = "#e09fb0";

            try {
                tg.sendData(JSON.stringify(d));
                setTimeout(() => { tg.close(); }, 200);
            } catch (err) {
                alert("–û—à–∏–±–∫–∞: " + err.message);
            }
        }

        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            let rawAll = urlParams.get('all_data');
            if (rawAll) {
                try { allClients = JSON.parse(decodeURIComponent(rawAll)); } catch(e) {}
            }

            let rawEdit = urlParams.get('edit_data');
            if (rawEdit) {
                try {
                    const old = JSON.parse(decodeURIComponent(rawEdit));
                    if (old) {
                        document.getElementById('phone').value = old.phone || '';
                        document.getElementById('p_name').value = old.parent_name || old.name || '';
                        document.getElementById('c_name').value = old.child_name || '';
                        document.getElementById('c_age').value = old.child_age || '';
                        
                        let a = old.address || '';
                        document.getElementById('addr').value = a.includes('text=') ? decodeURIComponent(a.split('text=')[1]) : a;
                        
                        document.getElementById('source').value = old.source || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
                        document.getElementById('contract_sum').value = old.contract_sum || '';
                        document.getElementById('comm').value = old.comment || '';
                        if (old.datetime) { document.getElementById('dt').value = old.datetime.substring(0, 16); }
                        document.querySelectorAll('.service-btn').forEach(btn => {
                            if (btn.innerText === (old.service || '–î–µ—Ç—Å–∫–∏–π')) select(btn);
                        });
                    }
                } catch (e) { console.error(e); }
            }
        });
    </script>
</body>
</html>
